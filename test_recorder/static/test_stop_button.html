<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœæ­¢æŒ‰é’®æµ‹è¯•é¡µé¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .console-output {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .status-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container test-container">
        <h1 class="text-center mb-4">ğŸ”§ åœæ­¢æŒ‰é’®åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>æŒ‰é’®æµ‹è¯•åŒº</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success" id="startBtn">
                                <i class="bi bi-play-circle"></i> å¼€å§‹å½•åˆ¶
                            </button>
                            <button type="button" class="btn btn-danger" id="stopBtn" disabled>
                                <i class="bi bi-stop-circle"></i> åœæ­¢å½•åˆ¶
                            </button>
                            <button type="button" class="btn btn-warning" onclick="toggleRecordingState()">
                                <i class="bi bi-arrow-repeat"></i> åˆ‡æ¢å½•åˆ¶çŠ¶æ€
                            </button>
                            <button type="button" class="btn btn-info" onclick="testAPI()">
                                <i class="bi bi-cloud-arrow-down"></i> æµ‹è¯•API
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="runDiagnostics()">
                                <i class="bi bi-bug"></i> è¿è¡Œè¯Šæ–­
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="status-info">
                    <h6>å½“å‰çŠ¶æ€</h6>
                    <p>å½•åˆ¶çŠ¶æ€: <span id="recording-status" class="badge bg-secondary">æœªçŸ¥</span></p>
                    <p>åœæ­¢æŒ‰é’®: <span id="stop-btn-status" class="badge bg-secondary">æœªçŸ¥</span></p>
                    <p>å¼€å§‹æŒ‰é’®: <span id="start-btn-status" class="badge bg-secondary">æœªçŸ¥</span></p>
                    <p>æœ€åæ“ä½œ: <span id="last-action">æ— </span></p>
                </div>
            </div>
        </div>
        
        <div class="console-output" id="console">
            [ç³»ç»Ÿ] åœæ­¢æŒ‰é’®æµ‹è¯•é¡µé¢å·²åŠ è½½<br>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let isRecording = false;
        let testConsole = document.getElementById('console');
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'info': '#0f0',
                'warn': '#ff0',
                'error': '#f00',
                'success': '#0f0'
            };
            const color = colors[type] || '#0f0';
            testConsole.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            testConsole.scrollTop = testConsole.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay() {
            document.getElementById('recording-status').textContent = isRecording ? 'å½•åˆ¶ä¸­' : 'æœªå½•åˆ¶';
            document.getElementById('recording-status').className = `badge ${isRecording ? 'bg-success' : 'bg-secondary'}`;
            
            const stopBtn = document.getElementById('stopBtn');
            const startBtn = document.getElementById('startBtn');
            
            document.getElementById('stop-btn-status').textContent = stopBtn.disabled ? 'ç¦ç”¨' : 'å¯ç”¨';
            document.getElementById('stop-btn-status').className = `badge ${stopBtn.disabled ? 'bg-danger' : 'bg-success'}`;
            
            document.getElementById('start-btn-status').textContent = startBtn.disabled ? 'ç¦ç”¨' : 'å¯ç”¨';
            document.getElementById('start-btn-status').className = `badge ${startBtn.disabled ? 'bg-danger' : 'bg-success'}`;
        }
        
        // åˆ‡æ¢å½•åˆ¶çŠ¶æ€ï¼ˆæ¨¡æ‹Ÿï¼‰
        function toggleRecordingState() {
            isRecording = !isRecording;
            log(`æ‰‹åŠ¨åˆ‡æ¢å½•åˆ¶çŠ¶æ€ä¸º: ${isRecording}`, 'info');
            updateUI();
        }
        
        // æ›´æ–°UIçŠ¶æ€
        function updateUI() {
            const stopBtn = document.getElementById('stopBtn');
            const startBtn = document.getElementById('startBtn');
            
            if (isRecording) {
                stopBtn.disabled = false;
                stopBtn.className = 'btn btn-danger';
                startBtn.disabled = true;
            } else {
                stopBtn.disabled = true;
                stopBtn.className = 'btn btn-secondary';
                startBtn.disabled = false;
            }
            
            updateStatusDisplay();
            document.getElementById('last-action').textContent = `æ›´æ–°UIçŠ¶æ€ (${new Date().toLocaleTimeString()})`;
        }
        
        // æµ‹è¯•API
        async function testAPI() {
            log('å¼€å§‹æµ‹è¯•APIè°ƒç”¨...', 'info');
            
            try {
                const response = await fetch('/api/recording/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`APIå“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
                
                const result = await response.json();
                log(`APIå“åº”å†…å®¹: ${JSON.stringify(result, null, 2)}`, 'success');
                
                if (result.success) {
                    log('APIè°ƒç”¨æˆåŠŸ!', 'success');
                } else {
                    log(`APIè°ƒç”¨å¤±è´¥: ${result.message || result.error}`, 'error');
                }
                
            } catch (error) {
                log(`APIè°ƒç”¨å¼‚å¸¸: ${error.message}`, 'error');
            }
        }
        
        // è¿è¡Œè¯Šæ–­
        function runDiagnostics() {
            log('å¼€å§‹è¿è¡Œè¯Šæ–­...', 'info');
            
            // æ£€æŸ¥å…ƒç´ 
            const stopBtn = document.getElementById('stopBtn');
            const startBtn = document.getElementById('startBtn');
            
            log(`åœæ­¢æŒ‰é’®å…ƒç´ : ${stopBtn ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, stopBtn ? 'success' : 'error');
            log(`å¼€å§‹æŒ‰é’®å…ƒç´ : ${startBtn ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, startBtn ? 'success' : 'error');
            
            if (stopBtn) {
                log(`åœæ­¢æŒ‰é’®ID: ${stopBtn.id}`, 'info');
                log(`åœæ­¢æŒ‰é’®ç±»å: ${stopBtn.className}`, 'info');
                log(`åœæ­¢æŒ‰é’®ç¦ç”¨çŠ¶æ€: ${stopBtn.disabled}`, 'info');
                log(`åœæ­¢æŒ‰é’®ç±»å‹: ${stopBtn.type}`, 'info');
            }
            
            // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
            log('æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨...', 'info');
            try {
                const listeners = getEventListeners ? getEventListeners(stopBtn) : null;
                if (listeners) {
                    log(`äº‹ä»¶ç›‘å¬å™¨: ${JSON.stringify(Object.keys(listeners))}`, 'info');
                } else {
                    log('æ— æ³•è·å–äº‹ä»¶ç›‘å¬å™¨ä¿¡æ¯ï¼ˆæ­£å¸¸ï¼‰', 'warn');
                }
            } catch (e) {
                log('äº‹ä»¶ç›‘å¬å™¨æ£€æŸ¥å¤±è´¥ï¼ˆæ­£å¸¸ï¼‰', 'warn');
            }
            
            // æ£€æŸ¥å…¨å±€å˜é‡
            log(`isRecordingå˜é‡: ${isRecording}`, 'info');
            log(`fetchå‡½æ•°: ${typeof fetch}`, 'info');
            log(`bootstrap: ${typeof bootstrap}`, 'info');
            
            log('è¯Šæ–­å®Œæˆ', 'success');
        }
        
        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            log('DOMåŠ è½½å®Œæˆï¼Œç»‘å®šäº‹ä»¶ç›‘å¬å™¨...', 'info');
            
            const stopBtn = document.getElementById('stopBtn');
            const startBtn = document.getElementById('startBtn');
            
            // å¼€å§‹æŒ‰é’®
            if (startBtn) {
                startBtn.addEventListener('click', function() {
                    log('å¼€å§‹æŒ‰é’®è¢«ç‚¹å‡»', 'info');
                    isRecording = true;
                    updateUI();
                    document.getElementById('last-action').textContent = 'ç‚¹å‡»å¼€å§‹æŒ‰é’®';
                });
            }
            
            // åœæ­¢æŒ‰é’® - å¤šé‡ç»‘å®š
            if (stopBtn) {
                // æ–¹æ³•1: addEventListener
                stopBtn.addEventListener('click', async function(e) {
                    log('åœæ­¢æŒ‰é’®è¢«ç‚¹å‡» (addEventListener)', 'warn');
                    e.preventDefault();
                    
                    if (stopBtn.disabled) {
                        log('åœæ­¢æŒ‰é’®å½“å‰è¢«ç¦ç”¨ï¼Œå¿½ç•¥ç‚¹å‡»', 'warn');
                        return;
                    }
                    
                    document.getElementById('last-action').textContent = 'ç‚¹å‡»åœæ­¢æŒ‰é’®';
                    
                    // æ¨¡æ‹ŸAPIè°ƒç”¨
                    stopBtn.disabled = true;
                    stopBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> å¤„ç†ä¸­...';
                    
                    try {
                        await testAPI();
                        isRecording = false;
                        updateUI();
                        log('åœæ­¢å½•åˆ¶å¤„ç†å®Œæˆ', 'success');
                    } catch (error) {
                        log(`åœæ­¢å½•åˆ¶å¤±è´¥: ${error.message}`, 'error');
                        updateUI();
                    }
                });
                
                // æ–¹æ³•2: onclick
                stopBtn.onclick = function() {
                    log('åœæ­¢æŒ‰é’®è¢«ç‚¹å‡» (onclick)', 'warn');
                };
                
                log('åœæ­¢æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ç»‘å®šå®Œæˆ', 'success');
            } else {
                log('åœæ­¢æŒ‰é’®ä¸å­˜åœ¨!', 'error');
            }
            
            updateUI();
            updateStatusDisplay();
            log('äº‹ä»¶ç»‘å®šå®Œæˆ', 'success');
        });
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            log('é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ', 'success');
            runDiagnostics();
        });
    </script>
</body>
</html> 